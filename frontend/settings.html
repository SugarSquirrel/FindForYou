<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š | æ—¥å¸¸ç‰©å“æœå°‹åŠ©æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card p.desc {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-danger {
            background: #f5576c;
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* è¼¸å…¥æ¡† */
        input,
        select,
        textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #38ef7d;
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* ç‰©å“å¡ç‰‡ */
        .object-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .object-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .object-card:hover {
            border-color: #38ef7d;
            transform: translateY(-2px);
        }

        .object-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
        }

        .object-card .info {
            padding: 12px;
        }

        .object-card .name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .object-card .meta {
            font-size: 12px;
            color: #888;
        }

        .object-card .badge {
            display: inline-block;
            background: rgba(56, 239, 125, 0.2);
            color: #38ef7d;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-top: 6px;
        }

        /* æ–°å¢ç‰©å“æŒ‰éˆ• */
        .add-object-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            background: rgba(56, 239, 125, 0.1);
            border: 2px dashed rgba(56, 239, 125, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-object-btn:hover {
            background: rgba(56, 239, 125, 0.2);
            border-color: #38ef7d;
        }

        .add-object-btn .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .add-object-btn span {
            color: #38ef7d;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(30, 30, 50, 0.98);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content .form-group {
            margin-bottom: 16px;
        }

        .modal-content label {
            display: block;
            color: #aaa;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .modal-content .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* ä¸Šå‚³å€ */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #38ef7d;
            background: rgba(56, 239, 125, 0.1);
        }

        .upload-area.has-image {
            padding: 10px;
        }

        .upload-area img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .upload-area .placeholder {
            color: #888;
        }

        .upload-area .placeholder .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #38ef7d;
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
            z-index: 2000;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .info-box {
            background: rgba(56, 239, 125, 0.1);
            border-left: 4px solid #38ef7d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box .title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #aaa;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-btn">â† è¿”å›</a>
            <h1>âš™ï¸ è¨­å®š</h1>
        </div>

        <!-- èªªæ˜ -->
        <div class="info-box">
            <div class="title">ğŸ“¹ å‰ç«¯æ”å½±æ©Ÿæ¶æ§‹</div>
            <p>
                æ”å½±æ©Ÿç”±ç€è¦½å™¨ç›´æ¥æ§åˆ¶ï¼Œç„¡éœ€å¾Œç«¯é…ç½®ã€‚åœ¨é¦–é é»æ“Šã€Œé–‹å•Ÿæ”å½±æ©Ÿã€å³å¯é–‹å§‹åµæ¸¬ã€‚
                è«‹ç¢ºä¿å·²æˆæ¬Šç€è¦½å™¨ä½¿ç”¨æ”å½±æ©Ÿæ¬Šé™ã€‚
            </p>
        </div>

        <!-- æˆ‘çš„ç‰©å“ -->
        <div class="card">
            <h2>ğŸ“¦ æˆ‘çš„ç‰©å“</h2>
            <p class="desc">è¨»å†Šä½ çš„å€‹äººç‰©å“ï¼Œç³»çµ±æœƒé€é AI ç‰¹å¾µæ¯”å°ä¾†è­˜åˆ¥å®ƒå€‘ã€‚æ‹æ”å¤šå¼µä¸åŒè§’åº¦çš„ç…§ç‰‡å¯æé«˜è­˜åˆ¥æº–ç¢ºåº¦ã€‚</p>

            <div class="object-grid" id="objectGrid">
                <!-- å‹•æ…‹å¡«å…¥ -->
            </div>
        </div>

        <!-- å¸¸ç”¨ç‰©å“å¿«æ· -->
        <div class="card">
            <h2>â­ å¸¸ç”¨ç‰©å“å¿«æ·</h2>
            <p class="desc">è‡ªè¨‚é¦–é é¡¯ç¤ºçš„å¸¸ç”¨ç‰©å“å¿«æ·æŒ‰éˆ•</p>

            <div id="quickItemsList" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;"></div>

            <div
                style="display:grid; grid-template-columns: 1fr 1fr 80px auto; gap:12px; padding:16px; background:rgba(255,215,0,0.1); border-radius:12px; border:2px dashed rgba(255,215,0,0.3);">
                <input type="text" id="newQuickItemName" placeholder="ç‰©å“åç¨±">
                <input type="text" id="newQuickItemIcon" placeholder="åœ–ç¤º (å¦‚: ğŸ“±)">
                <input type="number" id="newQuickItemOrder" placeholder="é †åº" min="1" max="10" value="1">
                <button class="btn btn-primary" onclick="addQuickItem()">æ–°å¢</button>
            </div>
        </div>

        <!-- æ”å½±æ©Ÿè¨­å®š -->
        <div class="card">
            <h2>ğŸ“· æ”å½±æ©Ÿè¨­å®š</h2>
            <p class="desc">è¨­å®šæ”å½±æ©Ÿå°æ‡‰çš„ä½ç½®åç¨±ï¼Œä»¥åŠé è¨­é–‹å•Ÿçš„æ”å½±æ©Ÿ</p>

            <div class="form-group" style="margin-bottom:20px;">
                <label>é è¨­æ”å½±æ©Ÿ</label>
                <select id="defaultCameraSelect" onchange="saveDefaultCamera()" style="max-width:300px;">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
            </div>

            <div style="margin-bottom:12px; color:#aaa;">æ”å½±æ©Ÿä½ç½®å°æ‡‰ï¼š</div>
            <div id="cameraLocationList" style="display:flex; flex-direction:column; gap:10px;">
                <div style="color:#888; padding:20px; text-align:center;">æ­£åœ¨åµæ¸¬æ”å½±æ©Ÿ...</div>
            </div>
        </div>

        <!-- ç³»çµ±è³‡è¨Š -->
        <div class="card">
            <h2>â„¹ï¸ ç³»çµ±è³‡è¨Š</h2>
            <div id="systemInfo" style="color:#aaa;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // ========================================
        // ç‰©å“ç®¡ç†
        // ========================================

        async function loadObjects() {
            try {
                const res = await fetch(`${API_BASE}/api/objects`);
                const data = await res.json();
                renderObjectGrid(data.objects || []);
            } catch (e) {
                console.error('è¼‰å…¥ç‰©å“å¤±æ•—', e);
                document.getElementById('objectGrid').innerHTML = `
                    <div style="text-align:center; padding:40px; color:#888;">
                        <div style="font-size:48px; margin-bottom:15px;">âš ï¸</div>
                        <p>ç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™</p>
                    </div>
                `;
            }
        }

        function renderObjectGrid(objects) {
            const container = document.getElementById('objectGrid');

            let html = objects.map(obj => `
                <div class="object-card" onclick="showObjectDetail('${obj.id}')">
                    <img src="${obj.thumbnail || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2230%22>ğŸ“¦</text></svg>'}" alt="${obj.name_zh}">
                    <div class="info">
                        <div class="name">${obj.name_zh}</div>
                        <div class="meta">${obj.name}</div>
                        <div class="badge">${obj.embedding_count} å¼µç…§ç‰‡</div>
                    </div>
                </div>
            `).join('');

            html += `
                <div class="add-object-btn" onclick="showRegisterModal()">
                    <div class="icon">â•</div>
                    <span>æ–°å¢ç‰©å“</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function showRegisterModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'registerModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:600px;">
                    <h3>ğŸ“¦ è¨»å†Šæ–°ç‰©å“</h3>
                    
                    <!-- Step 1: é¸æ“‡åœ–ç‰‡ä¾†æº -->
                    <div id="step1">
                        <p style="color:#aaa; margin-bottom:20px;">è«‹ä¸Šå‚³ç‰©å“ç…§ç‰‡æˆ–ä½¿ç”¨æ”å½±æ©Ÿæ‹ç…§</p>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()" style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="font-size:48px;">ğŸ“</div>
                                <div style="color:#aaa;">é¸æ“‡æª”æ¡ˆ</div>
                            </div>
                            <div class="upload-area" id="cameraArea" onclick="startCameraCapture()" style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="font-size:48px;">ğŸ“·</div>
                                <div style="color:#aaa;">ä½¿ç”¨æ”å½±æ©Ÿ</div>
                            </div>
                        </div>
                        
                        <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="onImageSelected(this)">
                        
                        <!-- æ”å½±æ©Ÿé è¦½ (éš±è—ç›´åˆ°å•Ÿç”¨) -->
                        <div id="cameraPreview" style="display:none; margin-bottom:20px;">
                            <video id="cameraVideo" autoplay playsinline muted style="width:100%; max-height:300px; border-radius:12px; background:#000;"></video>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button class="btn btn-primary" style="flex:1;" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
                                <button class="btn btn-secondary" onclick="stopCameraCapture()">å–æ¶ˆ</button>
                            </div>
                        </div>
                        
                        <div class="btn-group" id="step1BtnGroup">
                            <button class="btn btn-secondary" onclick="closeModal('registerModal')">å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: åµæ¸¬çµæœ -->
                    <div id="step2" style="display:none;">
                        <p style="color:#aaa; margin-bottom:15px;">æ­£åœ¨åµæ¸¬ä¸­...</p>
                        <div id="detectionPreview" style="text-align:center; margin-bottom:20px;">
                            <img id="detectedImage" style="max-width:100%; max-height:250px; border-radius:12px;">
                        </div>
                        <div id="detectionResults" style="margin-bottom:20px;"></div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="backToStep1()">â† é‡æ–°é¸æ“‡</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: ç¢ºèªè¨»å†Š -->
                    <div id="step3" style="display:none;">
                        <div id="selectedObjectPreview" style="text-align:center; margin-bottom:20px;">
                            <img id="selectedCropImage" style="max-width:200px; max-height:150px; border-radius:12px; border:2px solid #38ef7d;">
                        </div>
                        
                        <div class="form-group">
                            <label>ç‰©å“åç¨± (è‹±æ–‡ ID)</label>
                            <input type="text" id="regName" placeholder="ä¾‹å¦‚: my_wallet">
                        </div>
                        
                        <div class="form-group">
                            <label>ä¸­æ–‡åç¨±</label>
                            <input type="text" id="regNameZh" placeholder="ä¾‹å¦‚: æˆ‘çš„éŒ¢åŒ…">
                        </div>
                        
                        <div id="matchInfo" style="display:none; background:rgba(56,239,125,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
                            <span style="color:#38ef7d;">âœ… æ­¤ç‰©å“å·²è¨»å†Šï¼Œå°‡æ›´æ–°ç¾æœ‰è¨˜éŒ„</span>
                        </div>
                        
                        <!-- å½±ç‰‡æŠ“å–é¸é … -->
                        <div style="background:rgba(102,126,234,0.1); border:1px solid rgba(102,126,234,0.3); padding:16px; border-radius:12px; margin-bottom:16px;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <span style="font-size:20px;">ğŸ¬</span>
                                <span style="font-weight:500; color:#667eea;">å½±ç‰‡æ¨¡å¼ (æ¨è–¦)</span>
                            </div>
                            <p style="color:#aaa; font-size:13px; margin-bottom:12px;">
                                é€£çºŒæ‹æ”å¤šå¼µç…§ç‰‡ï¼Œå¯å¾ä¸åŒè§’åº¦æŠ“å–ç‰¹å¾µï¼Œæé«˜è¾¨è­˜æº–ç¢ºåº¦ã€‚
                            </p>
                            <button class="btn" style="background:#667eea; color:#fff; width:100%;" onclick="startVideoCapture()">
                                ğŸ“¹ é–‹å§‹å½±ç‰‡æŠ“å–
                            </button>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="backToStep2()">â† è¿”å›</button>
                            <button class="btn btn-primary" id="confirmRegBtn" onclick="confirmRegistration()">å¿«é€Ÿè¨»å†Š (å–®å¼µ)</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: å½±ç‰‡æŠ“å–æ¨¡å¼ -->
                    <div id="step4" style="display:none;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="position:relative; display:inline-block;">
                                <video id="videoCaptureVideo" autoplay playsinline muted style="width:100%; max-height:300px; border-radius:12px; background:#000;"></video>
                                <!-- bbox æ¡†æ¡†è¦†è“‹å±¤ -->
                                <div id="bboxOverlay" style="position:absolute; border:3px solid #38ef7d; border-radius:4px; pointer-events:none; box-shadow:0 0 20px rgba(56,239,125,0.5);"></div>
                            </div>
                        </div>
                        
                        <!-- æŠ“å–é€²åº¦ -->
                        <div style="background:rgba(0,0,0,0.3); padding:16px; border-radius:12px; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span>å·²æŠ“å–ç‰¹å¾µ</span>
                                <span id="captureCount" style="color:#38ef7d; font-weight:bold;">0 / 15</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.1); height:8px; border-radius:4px; overflow:hidden;">
                                <div id="captureProgress" style="background:linear-gradient(90deg, #38ef7d, #11998e); height:100%; width:0%; transition:width 0.3s;"></div>
                            </div>
                            <p id="captureStatus" style="color:#aaa; font-size:12px; margin-top:8px; text-align:center;">
                                è«‹ç¨å¾®ç§»å‹•ç‰©å“æˆ–æ‰‹æ©Ÿï¼Œå¾ä¸åŒè§’åº¦æ•æ‰ç‰¹å¾µ
                            </p>
                        </div>
                        
                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn btn-danger" id="stopCaptureBtn" onclick="stopVideoCapture()" style="min-width:150px;">
                                â¹ï¸ åœæ­¢æŠ“å–
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 5: å®Œæˆç¢ºèª -->
                    <div id="step5" style="display:none;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="font-size:64px; margin-bottom:10px;">âœ…</div>
                            <h3 style="color:#38ef7d;" id="finalNameZh">ç‰©å“åç¨±</h3>
                            <p style="color:#aaa;" id="finalStats">å·²æŠ“å– 0 å€‹ç‰¹å¾µ</p>
                        </div>
                        
                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn btn-secondary" onclick="backToStep3()">â† é‡æ–°è¨­å®š</button>
                            <button class="btn btn-primary" onclick="finishVideoRegistration()" style="min-width:150px;">ç¢ºèªè¨»å†Š</button>
                        </div>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal('registerModal');
            });

            document.body.appendChild(modal);
        }

        // æ”å½±æ©Ÿç›¸é—œè®Šæ•¸
        let cameraStream = null;
        let pendingImageData = null;
        let pendingDetections = null;
        let selectedDetection = null;

        async function startCameraCapture() {
            try {
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('cameraArea').style.display = 'none';
                document.getElementById('step1BtnGroup').style.display = 'none';
                document.getElementById('cameraPreview').style.display = 'block';

                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;

            } catch (e) {
                console.error('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ:', e);
                showToast('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');
                stopCameraCapture();
            }
        }

        function stopCameraCapture() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraVideo').srcObject = null;
            document.getElementById('cameraPreview').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'flex';
            document.getElementById('cameraArea').style.display = 'flex';
            document.getElementById('step1BtnGroup').style.display = 'flex';
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                stopCameraCapture();
                await processImage(blob);
            }, 'image/jpeg', 0.9);
        }

        async function onImageSelected(input) {
            if (input.files && input.files[0]) {
                await processImage(input.files[0]);
            }
        }

        async function processImage(blob) {
            // é¡¯ç¤º Step 2
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';

            // é è¦½åœ–ç‰‡
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('detectedImage').src = e.target.result;
                pendingImageData = e.target.result;
            };
            reader.readAsDataURL(blob);

            // å‘¼å«åµæ¸¬ API
            try {
                const formData = new FormData();
                formData.append('file', blob, 'capture.jpg');

                const res = await fetch(`${API_BASE}/api/detect/image`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success && data.detections && data.detections.length > 0) {
                    pendingDetections = data.detections;
                    // å„²å­˜åŸå§‹åœ–ç‰‡ç”¨æ–¼è¨»å†Š
                    pendingImageData = data.image_original_base64 || data.image_base64;
                    // é¡¯ç¤ºå¸¶æ¨™è¨»çš„åœ–ç‰‡
                    document.getElementById('detectedImage').src = data.image_base64;
                    showDetectionResults(data.detections);
                } else {
                    document.getElementById('detectionResults').innerHTML = `
                        <div style="text-align:center; padding:20px; color:#888;">
                            <div style="font-size:48px; margin-bottom:10px;">ğŸ¤”</div>
                            <p>æœªåµæ¸¬åˆ°ç‰©å“</p>
                            <p style="font-size:12px;">è«‹å˜—è©¦å…¶ä»–è§’åº¦æˆ–æ›´æ¸…æ™°çš„ç…§ç‰‡</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('åµæ¸¬å¤±æ•—:', e);
                document.getElementById('detectionResults').innerHTML = `
                    <div style="text-align:center; padding:20px; color:#f5576c;">
                        <p>åµæ¸¬å¤±æ•—</p>
                        <p style="font-size:12px;">${e.message}</p>
                    </div>
                `;
            }
        }

        function showDetectionResults(detections) {
            const container = document.getElementById('detectionResults');

            container.innerHTML = `
                <p style="color:#fff; margin-bottom:12px;">åµæ¸¬åˆ° ${detections.length} å€‹ç‰©å“ï¼Œè«‹é¸æ“‡è¦è¨»å†Šçš„ç‰©å“ï¼š</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    ${detections.map((det, idx) => {
                const isMatched = det.matched_object_id;
                const matchBadge = isMatched
                    ? `<span style="background:rgba(56,239,125,0.2); color:#38ef7d; padding:2px 8px; border-radius:10px; font-size:11px;">âœ… å·²è¨»å†Š</span>`
                    : `<span style="background:rgba(102,126,234,0.2); color:#667eea; padding:2px 8px; border-radius:10px; font-size:11px;">â• æ–°ç‰©ä»¶</span>`;
                const actionText = isMatched ? 'æ›´æ–°' : 'è¨»å†Š';

                return `
                            <div onclick="selectDetection(${idx})" style="
                                display:flex; align-items:center; justify-content:space-between;
                                background:rgba(255,255,255,0.05); padding:12px 16px; border-radius:10px;
                                cursor:pointer; transition:all 0.2s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <span style="font-size:24px;">ğŸ“¦</span>
                                    <div>
                                        <div style="font-weight:500;">${det.object_class_zh || det.object_class}</div>
                                        <div style="font-size:12px; color:#888;">ä¿¡å¿ƒåº¦: ${Math.round((det.similarity || det.confidence) * 100)}%</div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    ${matchBadge}
                                    <button class="btn btn-primary" style="padding:6px 12px; font-size:12px;">${actionText}</button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function selectDetection(idx) {
            selectedDetection = pendingDetections[idx];

            // é¡¯ç¤º Step 3
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'block';

            // é¡¯ç¤ºé è¦½åœ–
            document.getElementById('selectedCropImage').src = pendingImageData;

            // é å¡«åç¨±
            const isMatched = selectedDetection.matched_object_id;
            if (isMatched) {
                document.getElementById('regName').value = selectedDetection.matched_object_name || selectedDetection.object_class;
                document.getElementById('regNameZh').value = selectedDetection.matched_object_name_zh || selectedDetection.object_class_zh;
                document.getElementById('matchInfo').style.display = 'block';
                document.getElementById('confirmRegBtn').textContent = 'æ›´æ–°ç‰©å“';
            } else {
                document.getElementById('regName').value = (selectedDetection.object_class || '').replace(/\s+/g, '_');
                document.getElementById('regNameZh').value = selectedDetection.object_class_zh || '';
                document.getElementById('matchInfo').style.display = 'none';
                document.getElementById('confirmRegBtn').textContent = 'ç¢ºèªè¨»å†Š';
            }
        }

        function backToStep1() {
            stopCameraCapture();
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'flex';
            document.getElementById('cameraArea').style.display = 'flex';
            pendingDetections = null;
            pendingImageData = null;
        }

        function backToStep2() {
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            selectedDetection = null;
        }

        async function confirmRegistration() {
            const name = document.getElementById('regName').value.trim();
            const nameZh = document.getElementById('regNameZh').value.trim();

            if (!name || !nameZh) {
                showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                return;
            }

            const isUpdate = selectedDetection && selectedDetection.matched_object_id;

            try {
                showToast(isUpdate ? 'æ›´æ–°ä¸­...' : 'è¨»å†Šä¸­...');

                // ä½¿ç”¨ register-cropped API
                const response = await fetch(`${API_BASE}/api/objects/register-cropped`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: pendingImageData,
                        bbox: selectedDetection?.bbox || [0, 0, 100, 100],
                        name: name,
                        name_zh: nameZh
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(isUpdate ? `å·²æ›´æ–°: ${nameZh}` : `å·²è¨»å†Š: ${nameZh}`);
                    closeModal('registerModal');
                    loadObjects();
                } else {
                    showToast(data.detail || 'æ“ä½œå¤±æ•—');
                }
            } catch (e) {
                console.error('æ“ä½œå¤±æ•—:', e);
                showToast('æ“ä½œå¤±æ•—');
            }
        }

        // ========================================
        // å½±ç‰‡æŠ“å–æ¨¡å¼
        // ========================================

        let videoCaptureStream = null;
        let videoCaptureInterval = null;
        let videoSessionId = null;
        let videoCaptureCount = 0;
        const VIDEO_CAPTURE_INTERVAL_MS = 300;  // æ¯ 300ms æŠ“å–ä¸€å¹€
        const VIDEO_MAX_CAPTURES = 15;          // æœ€å¤šæŠ“å– 15 å¹€
        const VIDEO_MIN_CAPTURES = 5;           // æœ€å°‘éœ€è¦ 5 å¹€

        async function startVideoCapture() {
            const name = document.getElementById('regName').value.trim();
            const nameZh = document.getElementById('regNameZh').value.trim();

            if (!name || !nameZh) {
                showToast('è«‹å…ˆå¡«å¯«ç‰©å“åç¨±');
                return;
            }

            try {
                // é–‹å§‹ session
                showToast('åˆå§‹åŒ–å½±ç‰‡æŠ“å–...');

                const startRes = await fetch(`${API_BASE}/api/objects/register-video-start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: pendingImageData,
                        bbox: selectedDetection?.bbox || [0, 0, 100, 100]
                    })
                });

                const startData = await startRes.json();

                if (!startData.success) {
                    showToast(startData.detail || 'ç„¡æ³•é–‹å§‹å½±ç‰‡æŠ“å–');
                    return;
                }

                videoSessionId = startData.session_id;
                videoCaptureCount = 1;  // å·²ç¶“æœ‰ç¬¬ä¸€å¹€

                // åˆ‡æ›åˆ° Step 4
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'block';

                // é–‹å•Ÿæ”å½±æ©Ÿ
                videoCaptureStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                const video = document.getElementById('videoCaptureVideo');
                video.srcObject = videoCaptureStream;

                // ç­‰å¾… video æº–å‚™å¥½å¾Œæ›´æ–° bbox overlay
                video.onloadedmetadata = () => {
                    updateBboxOverlay(startData.bbox, video);
                };

                // æ›´æ–°é€²åº¦
                updateCaptureProgress();

                // é–‹å§‹è‡ªå‹•æŠ“å–
                videoCaptureInterval = setInterval(async () => {
                    if (videoCaptureCount >= VIDEO_MAX_CAPTURES) {
                        stopVideoCapture();
                        return;
                    }

                    await captureVideoFrame();
                }, VIDEO_CAPTURE_INTERVAL_MS);

                showToast('é–‹å§‹æŠ“å–ç‰¹å¾µï¼Œè«‹ç¨å¾®ç§»å‹•ç‰©å“...');

            } catch (e) {
                console.error('å½±ç‰‡æŠ“å–å¤±æ•—:', e);
                showToast('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');
                cancelVideoCapture();
            }
        }

        function updateBboxOverlay(bbox, video) {
            const overlay = document.getElementById('bboxOverlay');
            if (!overlay || !video || !bbox) return;

            const videoRect = video.getBoundingClientRect();
            const scaleX = videoRect.width / video.videoWidth;
            const scaleY = videoRect.height / video.videoHeight;

            const [x1, y1, x2, y2] = bbox;
            overlay.style.left = (x1 * scaleX) + 'px';
            overlay.style.top = (y1 * scaleY) + 'px';
            overlay.style.width = ((x2 - x1) * scaleX) + 'px';
            overlay.style.height = ((y2 - y1) * scaleY) + 'px';
        }

        async function captureVideoFrame() {
            if (!videoSessionId || !videoCaptureStream) return;

            try {
                const video = document.getElementById('videoCaptureVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.85);

                const res = await fetch(`${API_BASE}/api/objects/register-video-frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: videoSessionId,
                        image_base64: imageData
                    })
                });

                const data = await res.json();

                if (data.success) {
                    videoCaptureCount = data.frame_count;
                    updateCaptureProgress(data.similarity, data.captured);

                    // å¦‚æœæŠ“å–åˆ°æ–°è§’åº¦ï¼Œé–ƒçˆæç¤º
                    if (data.captured) {
                        flashCaptureIndicator();
                    }
                }

            } catch (e) {
                console.error('æŠ“å–å¹€å¤±æ•—:', e);
            }
        }

        function flashCaptureIndicator() {
            const overlay = document.getElementById('bboxOverlay');
            if (overlay) {
                overlay.style.boxShadow = '0 0 30px rgba(56,239,125,1)';
                setTimeout(() => {
                    overlay.style.boxShadow = '0 0 20px rgba(56,239,125,0.5)';
                }, 200);
            }
        }

        let lastSimilarity = 0;

        function updateCaptureProgress(similarity, captured) {
            const countEl = document.getElementById('captureCount');
            const progressEl = document.getElementById('captureProgress');
            const statusEl = document.getElementById('captureStatus');

            if (countEl) countEl.textContent = `${videoCaptureCount} / ${VIDEO_MAX_CAPTURES}`;
            if (progressEl) progressEl.style.width = (videoCaptureCount / VIDEO_MAX_CAPTURES * 100) + '%';

            if (similarity !== undefined) {
                lastSimilarity = similarity;
            }

            if (statusEl) {
                const simPercent = Math.round(lastSimilarity * 100);

                if (videoCaptureCount >= VIDEO_MAX_CAPTURES) {
                    statusEl.textContent = 'å·²é”æœ€å¤§å¹€æ•¸ï¼Œè‡ªå‹•å®Œæˆ';
                    statusEl.style.color = '#38ef7d';
                } else if (captured) {
                    statusEl.textContent = `âœ… æ–°è§’åº¦å·²æŠ“å–ï¼ç¹¼çºŒæ—‹è½‰ç‰©å“... (ç›¸ä¼¼åº¦: ${simPercent}%)`;
                    statusEl.style.color = '#38ef7d';
                } else if (lastSimilarity > 0) {
                    // é¡¯ç¤ºç›¸ä¼¼åº¦æç¤º
                    if (lastSimilarity > 0.95) {
                        statusEl.textContent = `ğŸ“ è§’åº¦å¹¾ä¹ç›¸åŒ (${simPercent}%) - è«‹å¤§å¹…æ—‹è½‰ç‰©å“`;
                    } else if (lastSimilarity > 0.90) {
                        statusEl.textContent = `ğŸ”„ è§’åº¦ç•¥æœ‰è®ŠåŒ– (${simPercent}%) - ç¹¼çºŒæ—‹è½‰`;
                    } else if (lastSimilarity > 0.85) {
                        statusEl.textContent = `â³ å¿«åˆ°äº†! (${simPercent}%) - å†è½‰ä¸€é»é»`;
                    } else {
                        statusEl.textContent = `ğŸ¯ åµæ¸¬ä¸­... (${simPercent}%)`;
                    }
                    statusEl.style.color = lastSimilarity > 0.90 ? '#f5576c' : lastSimilarity > 0.85 ? '#ffc107' : '#38ef7d';
                } else {
                    statusEl.textContent = 'è«‹ç¨å¾®ç§»å‹•ç‰©å“æˆ–æ‰‹æ©Ÿï¼Œå¾ä¸åŒè§’åº¦æ•æ‰ç‰¹å¾µ';
                    statusEl.style.color = '#aaa';
                }
            }
        }

        function stopVideoCapture() {
            // åœæ­¢è‡ªå‹•æŠ“å–
            if (videoCaptureInterval) {
                clearInterval(videoCaptureInterval);
                videoCaptureInterval = null;
            }

            // åœæ­¢æ”å½±æ©Ÿ
            if (videoCaptureStream) {
                videoCaptureStream.getTracks().forEach(track => track.stop());
                videoCaptureStream = null;
            }

            const video = document.getElementById('videoCaptureVideo');
            if (video) video.srcObject = null;

            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„å¹€
            if (videoCaptureCount < VIDEO_MIN_CAPTURES) {
                showToast(`è‡³å°‘éœ€è¦ ${VIDEO_MIN_CAPTURES} å¹€ç‰¹å¾µ`);
                return;
            }

            // é€²å…¥ Step 5
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step5').style.display = 'block';

            document.getElementById('finalNameZh').textContent = document.getElementById('regNameZh').value;
            document.getElementById('finalStats').textContent = `å·²æŠ“å– ${videoCaptureCount} å€‹ç‰¹å¾µ`;
        }

        async function finishVideoRegistration() {
            const name = document.getElementById('regName').value.trim();
            const nameZh = document.getElementById('regNameZh').value.trim();

            if (!videoSessionId) {
                showToast('Session ä¸å­˜åœ¨');
                return;
            }

            try {
                showToast('æ­£åœ¨è¨»å†Š...');

                const res = await fetch(`${API_BASE}/api/objects/register-video-finish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: videoSessionId,
                        name: name,
                        name_zh: nameZh
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showToast(`å·²è¨»å†Š: ${nameZh} (${data.object.embedding_count} å€‹ç‰¹å¾µ)`);
                    closeModal('registerModal');
                    loadObjects();
                } else {
                    showToast(data.detail || 'è¨»å†Šå¤±æ•—');
                }

            } catch (e) {
                console.error('è¨»å†Šå¤±æ•—:', e);
                showToast('è¨»å†Šå¤±æ•—');
            } finally {
                videoSessionId = null;
                videoCaptureCount = 0;
            }
        }

        async function cancelVideoCapture() {
            if (videoCaptureInterval) {
                clearInterval(videoCaptureInterval);
                videoCaptureInterval = null;
            }

            if (videoCaptureStream) {
                videoCaptureStream.getTracks().forEach(track => track.stop());
                videoCaptureStream = null;
            }

            if (videoSessionId) {
                try {
                    await fetch(`${API_BASE}/api/objects/register-video-cancel/${videoSessionId}`, {
                        method: 'DELETE'
                    });
                } catch (e) { }
                videoSessionId = null;
            }

            videoCaptureCount = 0;
        }

        function backToStep3() {
            cancelVideoCapture();
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
            document.getElementById('step3').style.display = 'block';
        }

        function previewImage(input) {
            // ä¿ç•™èˆŠç‰ˆç›¸å®¹æ€§
            onImageSelected(input);
        }

        async function registerObject() {
            // èˆŠç‰ˆ APIï¼Œä¿ç•™ç›¸å®¹
        }

        async function showObjectDetail(objId) {
            try {
                const res = await fetch(`${API_BASE}/api/objects/${objId}`);
                const data = await res.json();

                if (!data.success) {
                    showToast('è¼‰å…¥å¤±æ•—');
                    return;
                }

                const obj = data.object;

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'detailModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>ğŸ“¦ ${obj.name_zh}</h3>
                        
                        <div style="margin-bottom:16px; max-height:200px; overflow-y:auto; border-radius:8px;">
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                ${obj.images.map(img => `
                                    <img src="${img}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer;" onclick="window.open('${img}', '_blank')">
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.2); padding:12px; border-radius:8px; margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="color:#888;">ID</span>
                                <span>${obj.id}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="color:#888;">è‹±æ–‡åç¨±</span>
                                <span>${obj.name}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:#888;">ç…§ç‰‡æ•¸é‡</span>
                                <span>${obj.embedding_count}</span>
                            </div>
                        </div>
                        
                        <div class="btn-group" style="justify-content:space-between;">
                            <button class="btn btn-danger" onclick="deleteObject('${obj.id}')">åˆªé™¤ç‰©å“</button>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-secondary" onclick="closeModal('detailModal')">é—œé–‰</button>
                                <button class="btn btn-primary" onclick="addMorePhotos('${obj.id}', '${obj.name}', '${obj.name_zh}')">æ–°å¢ç…§ç‰‡</button>
                            </div>
                        </div>
                    </div>
                `;

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal('detailModal');
                });

                document.body.appendChild(modal);
            } catch (e) {
                console.error('è¼‰å…¥ç‰©å“è©³æƒ…å¤±æ•—', e);
                showToast('è¼‰å…¥å¤±æ•—');
            }
        }

        // æ–°å¢ç…§ç‰‡ç”¨çš„å…¨åŸŸè®Šæ•¸
        let addPhotoObjId = null;
        let addPhotoObjName = null;
        let addPhotoObjNameZh = null;
        let addPhotoCameraStream = null;
        let addPhotoPendingImageData = null;
        let addPhotoPendingDetections = null;
        let addPhotoSelectedBbox = null;
        // å½±ç‰‡æŠ“å–ç”¨
        let addPhotoVideoStream = null;
        let addPhotoVideoInterval = null;
        let addPhotoVideoSessionId = null;
        let addPhotoVideoCaptureCount = 0;
        let addPhotoLastSimilarity = 0;

        function addMorePhotos(objId, objName, objNameZh) {
            closeModal('detailModal');
            addPhotoObjId = objId;
            addPhotoObjName = objName;
            addPhotoObjNameZh = objNameZh;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'addPhotoModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:600px;">
                    <h3>ğŸ“· æ–°å¢ç…§ç‰‡ - ${objNameZh || objId}</h3>
                    
                    <!-- Step 1: é¸æ“‡åœ–ç‰‡ä¾†æº -->
                    <div id="addPhotoStep1">
                        <p style="color:#aaa; margin-bottom:20px;">è«‹ä¸Šå‚³ç‰©å“ç…§ç‰‡æˆ–ä½¿ç”¨æ”å½±æ©Ÿæ‹ç…§</p>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                            <div class="upload-area" id="uploadAreaAdd" onclick="document.getElementById('imageInputAdd').click()" style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="font-size:48px;">ğŸ“</div>
                                <div style="color:#aaa;">é¸æ“‡æª”æ¡ˆ</div>
                            </div>
                            <div class="upload-area" id="cameraAreaAdd" onclick="startAddPhotoCamera()" style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="font-size:48px;">ğŸ“·</div>
                                <div style="color:#aaa;">ä½¿ç”¨æ”å½±æ©Ÿ</div>
                            </div>
                        </div>
                        
                        <input type="file" id="imageInputAdd" accept="image/*" style="display:none" onchange="onAddPhotoImageSelected(this)">
                        
                        <!-- æ”å½±æ©Ÿé è¦½ -->
                        <div id="cameraPreviewAdd" style="display:none; margin-bottom:20px;">
                            <video id="cameraVideoAdd" autoplay playsinline muted style="width:100%; max-height:300px; border-radius:12px; background:#000;"></video>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button class="btn btn-primary" style="flex:1;" onclick="captureAddPhoto()">ğŸ“¸ æ‹ç…§</button>
                                <button class="btn btn-secondary" onclick="stopAddPhotoCamera()">å–æ¶ˆ</button>
                            </div>
                        </div>
                        
                        <div class="btn-group" id="addPhotoStep1BtnGroup">
                            <button class="btn btn-secondary" onclick="closeModal('addPhotoModal')">å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: åµæ¸¬çµæœ + é¸æ“‡å–®å¼µæˆ–å½±ç‰‡ -->
                    <div id="addPhotoStep2" style="display:none;">
                        <p style="color:#aaa; margin-bottom:15px;">è«‹é¸æ“‡è¦æ–°å¢çš„ç‰©ä»¶ï¼š</p>
                        <div id="addPhotoDetectionPreview" style="text-align:center; margin-bottom:20px;">
                            <img id="addPhotoDetectedImage" style="max-width:100%; max-height:250px; border-radius:12px;">
                        </div>
                        <div id="addPhotoDetectionResults" style="margin-bottom:20px;"></div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="backToAddPhotoStep1()">â† é‡æ–°é¸æ“‡</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: å½±ç‰‡æŠ“å–æ¨¡å¼ -->
                    <div id="addPhotoStep3" style="display:none;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="position:relative; display:inline-block;">
                                <video id="addPhotoVideoCaptureVideo" autoplay playsinline muted style="width:100%; max-height:300px; border-radius:12px; background:#000;"></video>
                                <div id="addPhotoBboxOverlay" style="position:absolute; border:3px solid #38ef7d; border-radius:4px; pointer-events:none; box-shadow:0 0 20px rgba(56,239,125,0.5);"></div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.3); padding:16px; border-radius:12px; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span>å·²æŠ“å–ç‰¹å¾µ</span>
                                <span id="addPhotoCaptureCount" style="color:#38ef7d; font-weight:bold;">0 / 15</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.1); height:8px; border-radius:4px; overflow:hidden;">
                                <div id="addPhotoCaptureProgress" style="background:linear-gradient(90deg, #38ef7d, #11998e); height:100%; width:0%; transition:width 0.3s;"></div>
                            </div>
                            <p id="addPhotoCaptureStatus" style="color:#aaa; font-size:12px; margin-top:8px; text-align:center;">
                                è«‹ç¨å¾®ç§»å‹•ç‰©å“æˆ–æ‰‹æ©Ÿï¼Œå¾ä¸åŒè§’åº¦æ•æ‰ç‰¹å¾µ
                            </p>
                        </div>
                        
                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn btn-danger" onclick="stopAddPhotoVideoCapture()" style="min-width:150px;">
                                â¹ï¸ åœæ­¢æŠ“å–
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 4: å®Œæˆç¢ºèª -->
                    <div id="addPhotoStep4" style="display:none;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <div style="font-size:64px; margin-bottom:10px;">âœ…</div>
                            <h3 style="color:#38ef7d;" id="addPhotoFinalCount">å·²æŠ“å– 0 å€‹ç‰¹å¾µ</h3>
                        </div>
                        
                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn btn-secondary" onclick="backToAddPhotoStep2()">â† é‡æ–°è¨­å®š</button>
                            <button class="btn btn-primary" onclick="finishAddPhotoVideoCapture()" style="min-width:150px;">ç¢ºèªæ–°å¢</button>
                        </div>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal('addPhotoModal');
            });

            document.body.appendChild(modal);
        }

        async function startAddPhotoCamera() {
            try {
                document.getElementById('uploadAreaAdd').style.display = 'none';
                document.getElementById('cameraAreaAdd').style.display = 'none';
                document.getElementById('addPhotoStep1BtnGroup').style.display = 'none';
                document.getElementById('cameraPreviewAdd').style.display = 'block';

                addPhotoCameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                document.getElementById('cameraVideoAdd').srcObject = addPhotoCameraStream;

            } catch (e) {
                console.error('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ:', e);
                showToast('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');
                stopAddPhotoCamera();
            }
        }

        function stopAddPhotoCamera() {
            if (addPhotoCameraStream) {
                addPhotoCameraStream.getTracks().forEach(track => track.stop());
                addPhotoCameraStream = null;
            }
            const videoEl = document.getElementById('cameraVideoAdd');
            if (videoEl) videoEl.srcObject = null;
            const previewEl = document.getElementById('cameraPreviewAdd');
            if (previewEl) previewEl.style.display = 'none';
            const uploadEl = document.getElementById('uploadAreaAdd');
            if (uploadEl) uploadEl.style.display = 'flex';
            const cameraEl = document.getElementById('cameraAreaAdd');
            if (cameraEl) cameraEl.style.display = 'flex';
            const btnGroup = document.getElementById('addPhotoStep1BtnGroup');
            if (btnGroup) btnGroup.style.display = 'flex';
        }

        function captureAddPhoto() {
            const video = document.getElementById('cameraVideoAdd');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                stopAddPhotoCamera();
                await processAddPhotoImage(blob);
            }, 'image/jpeg', 0.9);
        }

        async function onAddPhotoImageSelected(input) {
            if (input.files && input.files[0]) {
                await processAddPhotoImage(input.files[0]);
            }
        }

        async function processAddPhotoImage(blob) {
            // é¡¯ç¤º Step 2
            document.getElementById('addPhotoStep1').style.display = 'none';
            document.getElementById('addPhotoStep2').style.display = 'block';

            // é è¦½åœ–ç‰‡
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('addPhotoDetectedImage').src = e.target.result;
                addPhotoPendingImageData = e.target.result;
            };
            reader.readAsDataURL(blob);

            // å‘¼å«åµæ¸¬ API
            try {
                const formData = new FormData();
                formData.append('file', blob, 'capture.jpg');

                const res = await fetch(`${API_BASE}/api/detect/image`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success && data.detections && data.detections.length > 0) {
                    addPhotoPendingDetections = data.detections;
                    addPhotoPendingImageData = data.image_original_base64 || data.image_base64;
                    document.getElementById('addPhotoDetectedImage').src = data.image_base64;
                    showAddPhotoDetectionResults(data.detections);
                } else {
                    document.getElementById('addPhotoDetectionResults').innerHTML = `
                        <div style="text-align:center; padding:20px; color:#888;">
                            <div style="font-size:48px; margin-bottom:10px;">ğŸ¤”</div>
                            <p>æœªåµæ¸¬åˆ°ç‰©å“</p>
                            <p style="font-size:12px;">è«‹å˜—è©¦å…¶ä»–è§’åº¦æˆ–æ›´æ¸…æ™°çš„ç…§ç‰‡</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('åµæ¸¬å¤±æ•—:', e);
                document.getElementById('addPhotoDetectionResults').innerHTML = `
                    <div style="text-align:center; padding:20px; color:#f5576c;">
                        <p>åµæ¸¬å¤±æ•—</p>
                    </div>
                `;
            }
        }

        function showAddPhotoDetectionResults(detections) {
            const container = document.getElementById('addPhotoDetectionResults');

            container.innerHTML = `
                <p style="color:#fff; margin-bottom:12px;">åµæ¸¬åˆ° ${detections.length} å€‹ç‰©å“ï¼Œè«‹é¸æ“‡ï¼š</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    ${detections.map((det, idx) => `
                        <div style="
                            background:rgba(255,255,255,0.05); padding:12px 16px; border-radius:10px;
                        ">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                                <span style="font-size:24px;">ğŸ“¦</span>
                                <div>
                                    <div style="font-weight:500;">${det.object_class_zh || det.object_class}</div>
                                    <div style="font-size:12px; color:#888;">ä¿¡å¿ƒåº¦: ${Math.round((det.similarity || det.confidence) * 100)}%</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary" style="flex:1; padding:8px 12px; font-size:12px;" 
                                    onclick="selectAddPhotoDetection(${idx})">
                                    ğŸ“¸ å¿«é€Ÿæ–°å¢
                                </button>
                                <button class="btn" style="flex:1; padding:8px 12px; font-size:12px; background:#667eea; color:#fff;" 
                                    onclick="startAddPhotoVideoCapture(${idx})">
                                    ğŸ“¹ å½±ç‰‡æŠ“å–
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function selectAddPhotoDetection(idx) {
            const det = addPhotoPendingDetections[idx];
            addPhotoSelectedBbox = det.bbox;

            // ç›´æ¥ä¸Šå‚³
            try {
                showToast('ä¸Šå‚³ä¸­...');

                const response = await fetch(`${API_BASE}/api/objects/${addPhotoObjId}/images-cropped`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: addPhotoPendingImageData,
                        bbox: det.bbox || [0, 0, 100, 100]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('ç…§ç‰‡å·²æ–°å¢');
                    closeModal('addPhotoModal');
                    loadObjects();
                } else {
                    showToast(data.detail || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (e) {
                console.error('ä¸Šå‚³å¤±æ•—:', e);
                showToast('ä¸Šå‚³å¤±æ•—');
            }
        }

        function backToAddPhotoStep1() {
            stopAddPhotoCamera();
            cancelAddPhotoVideoCapture();
            document.getElementById('addPhotoStep2').style.display = 'none';
            document.getElementById('addPhotoStep3').style.display = 'none';
            document.getElementById('addPhotoStep4').style.display = 'none';
            document.getElementById('addPhotoStep1').style.display = 'block';
            document.getElementById('uploadAreaAdd').style.display = 'flex';
            document.getElementById('cameraAreaAdd').style.display = 'flex';
            addPhotoPendingDetections = null;
            addPhotoPendingImageData = null;
        }

        function backToAddPhotoStep2() {
            cancelAddPhotoVideoCapture();
            document.getElementById('addPhotoStep3').style.display = 'none';
            document.getElementById('addPhotoStep4').style.display = 'none';
            document.getElementById('addPhotoStep2').style.display = 'block';
        }

        async function startAddPhotoVideoCapture(idx) {
            const det = addPhotoPendingDetections[idx];
            addPhotoSelectedBbox = det.bbox;

            try {
                showToast('åˆå§‹åŒ–å½±ç‰‡æŠ“å–...');

                // é–‹å§‹ session
                const startRes = await fetch(`${API_BASE}/api/objects/register-video-start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: addPhotoPendingImageData,
                        bbox: det.bbox || [0, 0, 100, 100]
                    })
                });

                const startData = await startRes.json();

                if (!startData.success) {
                    showToast(startData.detail || 'ç„¡æ³•é–‹å§‹å½±ç‰‡æŠ“å–');
                    return;
                }

                addPhotoVideoSessionId = startData.session_id;
                addPhotoVideoCaptureCount = 1;

                // åˆ‡æ›åˆ° Step 3
                document.getElementById('addPhotoStep2').style.display = 'none';
                document.getElementById('addPhotoStep3').style.display = 'block';

                // é–‹å•Ÿæ”å½±æ©Ÿ
                addPhotoVideoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                const video = document.getElementById('addPhotoVideoCaptureVideo');
                video.srcObject = addPhotoVideoStream;

                video.onloadedmetadata = () => {
                    updateAddPhotoBboxOverlay(startData.bbox, video);
                };

                updateAddPhotoCaptureProgress();

                // é–‹å§‹è‡ªå‹•æŠ“å–
                addPhotoVideoInterval = setInterval(async () => {
                    if (addPhotoVideoCaptureCount >= VIDEO_MAX_CAPTURES) {
                        stopAddPhotoVideoCapture();
                        return;
                    }
                    await captureAddPhotoVideoFrame();
                }, VIDEO_CAPTURE_INTERVAL_MS);

                showToast('é–‹å§‹æŠ“å–ï¼Œè«‹æ—‹è½‰ç‰©å“...');

            } catch (e) {
                console.error('å½±ç‰‡æŠ“å–å¤±æ•—:', e);
                showToast('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');
                cancelAddPhotoVideoCapture();
            }
        }

        function updateAddPhotoBboxOverlay(bbox, video) {
            const overlay = document.getElementById('addPhotoBboxOverlay');
            if (!overlay || !video || !bbox) return;

            const videoRect = video.getBoundingClientRect();
            const scaleX = videoRect.width / video.videoWidth;
            const scaleY = videoRect.height / video.videoHeight;

            const [x1, y1, x2, y2] = bbox;
            overlay.style.left = (x1 * scaleX) + 'px';
            overlay.style.top = (y1 * scaleY) + 'px';
            overlay.style.width = ((x2 - x1) * scaleX) + 'px';
            overlay.style.height = ((y2 - y1) * scaleY) + 'px';
        }

        async function captureAddPhotoVideoFrame() {
            if (!addPhotoVideoSessionId || !addPhotoVideoStream) return;

            try {
                const video = document.getElementById('addPhotoVideoCaptureVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.85);

                const res = await fetch(`${API_BASE}/api/objects/register-video-frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: addPhotoVideoSessionId,
                        image_base64: imageData
                    })
                });

                const data = await res.json();

                if (data.success) {
                    addPhotoVideoCaptureCount = data.frame_count;
                    updateAddPhotoCaptureProgress(data.similarity, data.captured);

                    if (data.captured) {
                        flashAddPhotoCaptureIndicator();
                    }
                }

            } catch (e) {
                console.error('æŠ“å–å¹€å¤±æ•—:', e);
            }
        }

        function flashAddPhotoCaptureIndicator() {
            const overlay = document.getElementById('addPhotoBboxOverlay');
            if (overlay) {
                overlay.style.boxShadow = '0 0 30px rgba(56,239,125,1)';
                setTimeout(() => {
                    overlay.style.boxShadow = '0 0 20px rgba(56,239,125,0.5)';
                }, 200);
            }
        }

        function updateAddPhotoCaptureProgress(similarity, captured) {
            const countEl = document.getElementById('addPhotoCaptureCount');
            const progressEl = document.getElementById('addPhotoCaptureProgress');
            const statusEl = document.getElementById('addPhotoCaptureStatus');

            if (countEl) countEl.textContent = `${addPhotoVideoCaptureCount} / ${VIDEO_MAX_CAPTURES}`;
            if (progressEl) progressEl.style.width = (addPhotoVideoCaptureCount / VIDEO_MAX_CAPTURES * 100) + '%';

            if (similarity !== undefined) {
                addPhotoLastSimilarity = similarity;
            }

            if (statusEl) {
                const simPercent = Math.round(addPhotoLastSimilarity * 100);

                if (addPhotoVideoCaptureCount >= VIDEO_MAX_CAPTURES) {
                    statusEl.textContent = 'å·²é”æœ€å¤§å¹€æ•¸ï¼Œè‡ªå‹•å®Œæˆ';
                    statusEl.style.color = '#38ef7d';
                } else if (captured) {
                    statusEl.textContent = `âœ… æ–°è§’åº¦å·²æŠ“å–ï¼ç¹¼çºŒæ—‹è½‰... (${simPercent}%)`;
                    statusEl.style.color = '#38ef7d';
                } else if (addPhotoLastSimilarity > 0) {
                    if (addPhotoLastSimilarity > 0.95) {
                        statusEl.textContent = `ğŸ“ è§’åº¦ç›¸åŒ (${simPercent}%) - è«‹æ—‹è½‰ç‰©å“`;
                    } else if (addPhotoLastSimilarity > 0.90) {
                        statusEl.textContent = `ğŸ”„ è§’åº¦ç•¥è®Š (${simPercent}%) - ç¹¼çºŒæ—‹è½‰`;
                    } else if (addPhotoLastSimilarity > 0.85) {
                        statusEl.textContent = `â³ å¿«åˆ°äº†! (${simPercent}%)`;
                    }
                    statusEl.style.color = addPhotoLastSimilarity > 0.90 ? '#f5576c' : addPhotoLastSimilarity > 0.85 ? '#ffc107' : '#38ef7d';
                }
            }
        }

        function stopAddPhotoVideoCapture() {
            if (addPhotoVideoInterval) {
                clearInterval(addPhotoVideoInterval);
                addPhotoVideoInterval = null;
            }

            if (addPhotoVideoStream) {
                addPhotoVideoStream.getTracks().forEach(track => track.stop());
                addPhotoVideoStream = null;
            }

            const video = document.getElementById('addPhotoVideoCaptureVideo');
            if (video) video.srcObject = null;

            if (addPhotoVideoCaptureCount < VIDEO_MIN_CAPTURES) {
                showToast(`è‡³å°‘éœ€è¦ ${VIDEO_MIN_CAPTURES} å¹€`);
                return;
            }

            // é€²å…¥ Step 4
            document.getElementById('addPhotoStep3').style.display = 'none';
            document.getElementById('addPhotoStep4').style.display = 'block';
            document.getElementById('addPhotoFinalCount').textContent = `å·²æŠ“å– ${addPhotoVideoCaptureCount} å€‹ç‰¹å¾µ`;
        }

        async function finishAddPhotoVideoCapture() {
            if (!addPhotoVideoSessionId || !addPhotoObjId) {
                showToast('Session ä¸å­˜åœ¨');
                return;
            }

            try {
                showToast('æ­£åœ¨æ–°å¢...');

                const res = await fetch(`${API_BASE}/api/objects/${addPhotoObjId}/add-video-photos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: addPhotoVideoSessionId,
                        obj_id: addPhotoObjId
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showToast(`å·²æ–°å¢ ${data.embedding_count} å¼µç…§ç‰‡`);
                    closeModal('addPhotoModal');
                    loadObjects();
                } else {
                    showToast(data.detail || 'æ–°å¢å¤±æ•—');
                }

            } catch (e) {
                console.error('æ–°å¢å¤±æ•—:', e);
                showToast('æ–°å¢å¤±æ•—');
            } finally {
                addPhotoVideoSessionId = null;
                addPhotoVideoCaptureCount = 0;
            }
        }

        async function cancelAddPhotoVideoCapture() {
            if (addPhotoVideoInterval) {
                clearInterval(addPhotoVideoInterval);
                addPhotoVideoInterval = null;
            }

            if (addPhotoVideoStream) {
                addPhotoVideoStream.getTracks().forEach(track => track.stop());
                addPhotoVideoStream = null;
            }

            if (addPhotoVideoSessionId) {
                try {
                    await fetch(`${API_BASE}/api/objects/register-video-cancel/${addPhotoVideoSessionId}`, {
                        method: 'DELETE'
                    });
                } catch (e) { }
                addPhotoVideoSessionId = null;
            }

            addPhotoVideoCaptureCount = 0;
        }

        // èˆŠç‰ˆç›¸å®¹æ€§å‡½æ•¸ (ä¿ç•™ä½†ä¸ä½¿ç”¨)
        function previewImageAdd(input) {
            onAddPhotoImageSelected(input);
        }

        async function uploadMorePhoto(objId) {
            // èˆŠç‰ˆ APIï¼Œç¾åœ¨æ”¹ç”¨æ–°æµç¨‹
        }

        async function deleteObject(objId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©å“ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            try {
                const res = await fetch(`${API_BASE}/api/objects/${objId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    showToast('å·²åˆªé™¤');
                    closeModal('detailModal');
                    loadObjects();
                } else {
                    showToast('åˆªé™¤å¤±æ•—');
                }
            } catch (e) {
                console.error('åˆªé™¤å¤±æ•—', e);
                showToast('åˆªé™¤å¤±æ•—');
            }
        }

        function closeModal(id) {
            document.getElementById(id)?.remove();
        }

        // ========================================
        // å¸¸ç”¨ç‰©å“ç®¡ç†
        // ========================================

        const DEFAULT_QUICK_ITEMS = [
            { name: 'æ‰‹æ©Ÿ', icon: 'ğŸ“±', order: 1 },
            { name: 'é‘°åŒ™', icon: 'ğŸ”‘', order: 2 },
            { name: 'çœ¼é¡', icon: 'ğŸ‘“', order: 3 },
            { name: 'éŒ¢åŒ…', icon: 'ğŸ‘›', order: 4 }
        ];

        function getQuickItems() {
            const saved = localStorage.getItem('quickItems');
            return saved ? JSON.parse(saved) : DEFAULT_QUICK_ITEMS;
        }

        function saveQuickItems(items) {
            localStorage.setItem('quickItems', JSON.stringify(items));
        }

        function loadQuickItems() {
            renderQuickItemsList(getQuickItems());
        }

        function renderQuickItemsList(items) {
            const container = document.getElementById('quickItemsList');
            if (items.length === 0) {
                container.innerHTML = '<p style="color:#aaa;">å°šæœªè¨­å®šå¸¸ç”¨ç‰©å“</p>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="display:inline-flex; align-items:center; gap:8px; background:rgba(255,215,0,0.2); padding:8px 12px; border-radius:20px; font-size:14px;">
                    <span>${item.icon}</span>
                    <span>${item.name}</span>
                    <button onclick="removeQuickItem('${item.name}')" style="background:rgba(245,87,108,0.5); border:none; color:#fff; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px;">âœ•</button>
                </div>
            `).join('');
        }

        function addQuickItem() {
            const name = document.getElementById('newQuickItemName').value.trim();
            const icon = document.getElementById('newQuickItemIcon').value.trim() || 'ğŸ“¦';
            const order = parseInt(document.getElementById('newQuickItemOrder').value) || 1;

            if (!name) { alert('è«‹è¼¸å…¥ç‰©å“åç¨±'); return; }

            const items = getQuickItems();
            if (items.find(i => i.name === name)) {
                showToast('ç‰©å“å·²å­˜åœ¨');
                return;
            }

            items.push({ name, icon, order });
            items.sort((a, b) => a.order - b.order);
            saveQuickItems(items);

            document.getElementById('newQuickItemName').value = '';
            document.getElementById('newQuickItemIcon').value = '';

            showToast(`å·²æ–°å¢: ${icon} ${name}`);
            loadQuickItems();
        }

        function removeQuickItem(name) {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${name}ã€ï¼Ÿ`)) return;

            let items = getQuickItems();
            items = items.filter(i => i.name !== name);
            saveQuickItems(items);

            showToast(`å·²ç§»é™¤: ${name}`);
            loadQuickItems();
        }

        // ========================================
        // ç³»çµ±è³‡è¨Š
        // ========================================

        async function loadSystemInfo() {
            try {
                const res = await fetch(`${API_BASE}/api/health`);
                const data = await res.json();

                document.getElementById('systemInfo').innerHTML = `
                    <div style="display:grid; gap:8px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span>ç‰ˆæœ¬</span>
                            <span>${data.version}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>åµæ¸¬å™¨ç‹€æ…‹</span>
                            <span style="color:${data.detector_ready ? '#38ef7d' : '#f5576c'};">
                                ${data.detector_ready ? 'å°±ç·’' : 'æœªå°±ç·’'}
                            </span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>å·²è¨»å†Šç‰©å“</span>
                            <span>${data.registered_objects} å€‹</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('systemInfo').innerHTML = '<span style="color:#f5576c;">ç„¡æ³•é€£æ¥å¾Œç«¯</span>';
            }
        }

        // ========================================
        // æ”å½±æ©Ÿè¨­å®š
        // ========================================

        let availableCameras = [];

        function getCameraSettings() {
            const saved = localStorage.getItem('cameraSettings');
            return saved ? JSON.parse(saved) : { defaultCamera: '', locations: {} };
        }

        function saveCameraSettings(settings) {
            localStorage.setItem('cameraSettings', JSON.stringify(settings));
        }

        async function loadCameraSettings() {
            try {
                // ç²å–æ”å½±æ©Ÿæ¬Šé™ä¸¦åˆ—èˆ‰è£ç½®
                await navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(stream => stream.getTracks().forEach(track => track.stop()));

                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(d => d.kind === 'videoinput');

                if (availableCameras.length === 0) {
                    document.getElementById('cameraLocationList').innerHTML =
                        '<div style="color:#888; padding:20px; text-align:center;">æœªåµæ¸¬åˆ°æ”å½±æ©Ÿ</div>';
                    document.getElementById('defaultCameraSelect').innerHTML =
                        '<option value="">ç„¡å¯ç”¨æ”å½±æ©Ÿ</option>';
                    return;
                }

                const settings = getCameraSettings();

                // æ¸²æŸ“é è¨­æ”å½±æ©Ÿé¸å–®
                const defaultSelect = document.getElementById('defaultCameraSelect');
                defaultSelect.innerHTML = '<option value="">ä¸è‡ªå‹•é–‹å•Ÿ</option>' +
                    availableCameras.map((cam, idx) => {
                        const label = cam.label || `æ”å½±æ©Ÿ ${idx + 1}`;
                        const selected = settings.defaultCamera === cam.deviceId ? 'selected' : '';
                        return `<option value="${cam.deviceId}" ${selected}>${label}</option>`;
                    }).join('');

                // æ¸²æŸ“æ”å½±æ©Ÿä½ç½®åˆ—è¡¨
                renderCameraLocationList(settings);

            } catch (e) {
                console.error('ç„¡æ³•åˆ—èˆ‰æ”å½±æ©Ÿ:', e);
                document.getElementById('cameraLocationList').innerHTML =
                    `<div style="color:#f5576c; padding:20px; text-align:center;">
                        ç„¡æ³•å­˜å–æ”å½±æ©Ÿ<br><small>${e.message}</small>
                    </div>`;
            }
        }

        function renderCameraLocationList(settings) {
            const container = document.getElementById('cameraLocationList');

            container.innerHTML = availableCameras.map((cam, idx) => {
                const label = cam.label || `æ”å½±æ©Ÿ ${idx + 1}`;
                const location = settings.locations[cam.deviceId] || '';

                return `
                    <div style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.05); padding:12px 16px; border-radius:10px;">
                        <span style="font-size:20px;">ğŸ“¹</span>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${label}</div>
                            <div style="font-size:11px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${cam.deviceId.substring(0, 20)}...</div>
                        </div>
                        <input type="text" 
                            placeholder="ä½ç½®åç¨± (å¦‚: å®¢å»³)" 
                            value="${location}"
                            onchange="saveCameraLocation('${cam.deviceId}', this.value)"
                            style="width:150px; padding:8px; font-size:13px;">
                    </div>
                `;
            }).join('');
        }

        function saveDefaultCamera() {
            const select = document.getElementById('defaultCameraSelect');
            const settings = getCameraSettings();
            settings.defaultCamera = select.value;
            saveCameraSettings(settings);
            showToast('å·²å„²å­˜é è¨­æ”å½±æ©Ÿ');
        }

        function saveCameraLocation(deviceId, location) {
            const settings = getCameraSettings();
            if (location.trim()) {
                settings.locations[deviceId] = location.trim();
            } else {
                delete settings.locations[deviceId];
            }
            saveCameraSettings(settings);
            showToast('å·²å„²å­˜ä½ç½®è¨­å®š');
        }

        // ========================================
        // å·¥å…·å‡½æ•¸
        // ========================================

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // åˆå§‹åŒ–
        loadObjects();
        loadQuickItems();
        loadCameraSettings();
        loadSystemInfo();
    </script>
</body>

</html>